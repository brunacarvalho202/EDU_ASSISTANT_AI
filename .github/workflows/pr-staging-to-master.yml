name: 2. PR Autom√°tica - staging ‚Üí master

on:
  # üö® MUDAN√áA ESSENCIAL: Permite que outros workflows o chamem
  workflow_dispatch:
    inputs:
      message:
        description: 'Mensagem que acionou o dispatch'
        required: false
        default: 'Acionado automaticamente pelo CI'

permissions:
  pull-requests: write # Necess√°rio para criar o PR
  contents: read

jobs:
  create_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Criar PR staging ‚Üí master
        uses: actions/github-script@v7
        with:
          # O PAT (PR_CREATOR_TOKEN) √© usado para a permiss√£o de criar o PR
          github-token: ${{ secrets.PR_CREATOR_TOKEN }}
          script: |
            const head = "staging";
            const base = "master";
            const prTitle = "Merge autom√°tico: staging ‚Üí master";
            const prBody = "PR criada automaticamente ap√≥s atualiza√ß√£o em staging. Por favor, revise e aprove para ir √† produ√ß√£o.";

            // 1. Verifica se PR j√° existe
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head,
              base,
              state: "open"
            });

            if (prs.length > 0) {
              console.log(`‚ö†Ô∏è PR ${prs[0].number} j√° existe. N√£o ser√° criada novamente.`);
              return;
            }

            // 2. Tenta criar uma nova PR
            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: prTitle,
                body: prBody,
                head,
                base
              });
              console.log(`‚úÖ PR criada com sucesso: #${pr.data.number}`);
            } catch (e) {
              if (e.status === 422) {
                console.log("‚ÑπÔ∏è Nenhuma mudan√ßa entre staging e master. PR n√£o criada.");
              } else {
                throw e;
              }
            }