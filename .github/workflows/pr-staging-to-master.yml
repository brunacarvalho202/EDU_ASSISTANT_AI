name: 2. PR Automática - staging → master

on:
  push:
    branches:
      - staging

permissions:
  pull-requests: write
  contents: read

jobs:
  create_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Criar PR para master
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PR_CREATOR_TOKEN }}
          script: |
            const head = "staging";
            const base = "master";

            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head,
              base,
              state: "open"
            });

            if (prs.length > 0) {
              console.log("PR já existe");
              return;
            }

            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "Merge automático: staging → master",
                body: "PR criada automaticamente após atualização em staging.",
                head,
                base
              });
              console.log("PR criada #" + pr.data.number);
            } catch (e) {
              if (e.status === 422) {
                console.log("Nenhuma mudança entre staging e master.");
              } else {
                throw e;
              }
            }
