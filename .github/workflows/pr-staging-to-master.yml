name: 2. PR AutomÃ¡tica - staging â†’ master

on:
  workflow_dispatch:
    inputs:
      message:
        description: 'Mensagem do commit que acionou o sync'
        required: false
        default: 'Acionado pelo CI de staging'

permissions:
  pull-requests: write
  contents: read

jobs:
  create_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Criar PR para master
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PR_CREATOR_TOKEN }}  # NecessÃ¡rio para criar PR
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const head = `${owner}:staging`;
            const base = "master";

            console.log("ğŸ” Verificando se jÃ¡ existe PR aberta staging â†’ master...");

            const prs = await github.rest.pulls.list({
              owner,
              repo,
              state: "open"
            });

            const existing = prs.data.find(pr =>
              pr.head.ref === "staging" && pr.base.ref === "master"
            );

            if (existing) {
              console.log(`âš ï¸ PR jÃ¡ existe: #${existing.number}`);
              return;
            }

            console.log("ğŸ†• Nenhuma PR aberta. Criando nova PR...");

            try {
              const pr = await github.rest.pulls.create({
                owner,
                repo,
                title: "Merge automÃ¡tico: staging â†’ master",
                body: context.payload.inputs?.message || "PR criada automaticamente apÃ³s atualizaÃ§Ã£o em staging.",
                head: "staging",
                base: "master"
              });

              console.log(`âœ… PR criada com sucesso! #${pr.data.number}`);

            } catch (e) {
              if (e.status === 422) {
                console.log("âš ï¸ Nenhuma mudanÃ§a entre staging e master.");
              } else {
                console.error("âŒ Erro ao criar PR:", e);
                throw e;
              }
            }
