name: 1. CI - Testes e PR para Staging

on:
  push:
    branches:
      - dev

permissions:
  # Permiss√£o necess√°ria para ler o c√≥digo (Checkout)
  contents: read ¬† ¬† ¬† 
  # Permiss√£o base para o GITHUB_TOKEN, embora o PAT seja usado na Step de criar PR
  pull-requests: write 
  actions: read

jobs:
  run_tests_and_create_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout C√≥digo
        uses: actions/checkout@v4

      - name: Configurar Ambiente Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Instalar Depend√™ncias
        run: pip install -r requirements.txt

      # ----------------------------------------------------
      # RODAR TESTES UNIT√ÅRIOS
      # ----------------------------------------------------
      - name: Rodar Testes Unit√°rios
        env:
          # Mantido o uso da string vazia para pular testes de integra√ß√£o (quando coloca false ele n√£o funciona)
          RUN_INTEGRATION_TESTS: '' ¬†
        run: |
          echo "Rodando testes unit√°rios (ignorando testes de integra√ß√£o)..."
          pytest

      # ----------------------------------------------------
      # CRIAR PR DEV ‚Üí STAGING (CORRE√á√ÉO DE PERMISS√ÉO APLICADA)
      # ----------------------------------------------------
      - name: Criar Pull Request para Staging
        if: success() ¬† # s√≥ executa se os testes passarem
        uses: actions/github-script@v7
        with:
          # üö® Usa o PAT (PR_CREATOR_TOKEN) para ter permiss√£o de criar PRs
          github-token: ${{ secrets.PR_CREATOR_TOKEN }}
          script: |
            const headBranch = "dev";
            const baseBranch = "staging";
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            const prTitle = "Merge autom√°tico: dev ‚Üí staging";
            const prBody = "PR criada automaticamente ap√≥s testes passarem com sucesso.";

            // 1. Verifica se PR j√° existe
            const { data: prs } = await github.rest.pulls.list({
              owner: repoOwner,
              repo: repoName,
              head: headBranch,
              base: baseBranch,
              state: "open"
            });

            if (prs.length > 0) {
              console.log(`‚ö†Ô∏è PR ${prs[0].number} j√° existe. N√£o ser√° criada novamente.`);
              return;
            }

            // 2. Tenta criar uma nova PR
            try {
              const newPr = await github.rest.pulls.create({
                owner: repoOwner,
                repo: repoName,
                title: prTitle,
                head: headBranch,
                base: baseBranch,
                body: prBody
              });

              console.log(`‚úÖ PR #${newPr.data.number} criada com sucesso: ${headBranch} ‚Üí ${baseBranch}`);

            } catch (error) {
              if (error.status === 422) {
                console.log(`‚ÑπÔ∏è Nenhuma mudan√ßa entre ${headBranch} e ${baseBranch}. PR n√£o criada.`);
              } else {
                throw error;
              }
            }