name: 1. CI - Testes e PR para Staging

on:
  push:
    branches:
      - dev

jobs:
  run_tests_and_create_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Código
        uses: actions/checkout@v4

      - name: Configurar Ambiente Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Instalar Dependências
        run: pip install -r requirements.txt

      # ----------------------------------------------------
      # RODAR TESTES UNITÁRIOS
      # ----------------------------------------------------
      - name: Rodar Testes Unitários
        env:
          RUN_INTEGRATION_TESTS: ''  # vazio = falsy = pula integração
        run: |
          echo "Rodando testes unitários (ignorando testes de integração)..."
          pytest

      # ----------------------------------------------------
      # CRIAR PR DEV → STAGING (FORMA CORRETA)
      # ----------------------------------------------------
      - name: Criar Pull Request para Staging
        if: success()   # só executa se os testes passarem
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: context.repo.owner + ":dev",
              base: "staging",
              state: "open"
            });

            if (prs.length > 0) {
              console.log("PR já existe. Não será criada novamente.");
              return;
            }

            try {
              await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "Merge automático: dev → staging",
                head: "dev",
                base: "staging",
                body: "PR criada automaticamente após testes passarem com sucesso."
              });
            } catch (error) {
              if (error.status === 422) {
                console.log("Nenhuma mudança entre dev e staging. PR não criada.");
              } else {
                throw error;
              }
            }
